---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import BaseLayout from '../layouts/BaseLayout.astro';
import { format } from 'date-fns';
import Footer from '../components/Footer.astro';

const allPosts = await getCollection('posts', ({ data }) => {
  const includeDrafts = import.meta.env.PUBLIC_INCLUDE_DRAFTS === 'true';
  return includeDrafts || !data.draft;
});

const sortedPosts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

function calculateReadTime(content: string): number {
  const wordsPerMinute = 200;
  const wordCount = content.trim().split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
}

function formatReadTime(minutes: number): string {
  return `${minutes} min read`;
}
---

<BaseLayout title="Buried Treasure - Johannes Naylor's Blog" description="Technical blog by Johannes Naylor">
  <div class="max-w-3xl mx-auto px-5 md:px-10 py-5 min-h-screen">
    <header class="mb-12">
      <div class="flex justify-between items-center mb-8">
        <div class="flex-1"></div>
      </div>
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-4 text-black dark:text-white">
          Buried Treasure
        </h1>
        <p class="text-lg text-black dark:text-white">
          By Johannes Naylor
        </p>
        <nav
          aria-label="External links"
          class="flex flex-wrap justify-center gap-4 text-sm"
        >
          <a
            href="https://jonaylor.com"
            target="_blank"
            rel="noopener noreferrer"
            class="text-black dark:text-white underline hover:opacity-70 transition-opacity duration-200"
          >
            about me
          </a>
          <a
            href="https://bio.jonaylor.com"
            target="_blank"
            rel="noopener noreferrer"
            class="text-black dark:text-white underline hover:opacity-70 transition-opacity duration-200"
          >
            projects
          </a>
          <a
            href="https://github.com/jonaylor89"
            target="_blank"
            rel="noopener noreferrer"
            class="text-black dark:text-white underline hover:opacity-70 transition-opacity duration-200"
          >
            github
          </a>
          <a
            href="https://linkedin.com/in/john-naylor"
            target="_blank"
            rel="noopener noreferrer"
            class="text-black dark:text-white underline hover:opacity-70 transition-opacity duration-200"
          >
            linkedin
          </a>
          <a
            href="https://x.com/jonaylor89"
            target="_blank"
            rel="noopener noreferrer"
            class="text-black dark:text-white underline hover:opacity-70 transition-opacity duration-200"
          >
            X/twitter
          </a>
        </nav>
      </div>
    </header>

    <main>
      {sortedPosts.length === 0 ? (
        <section class="text-center py-12">
          <p class="text-black dark:text-white text-lg">
            No posts yet. Add some markdown files to the{' '}
            <code class="bg-gray-100 dark:bg-gray-800 text-black dark:text-white px-1 py-0.5 rounded">
              content/posts
            </code>{' '}
            directory to get started.
          </p>
        </section>
      ) : (
        <section>
          <h2 class="sr-only">Blog Posts</h2>
          <div class="flex flex-col gap-8">
            {sortedPosts.map((post, index) => (
              <article
                class={`${index !== sortedPosts.length - 1 ? 'border-b border-gray-200 dark:border-gray-700' : ''} pb-8`}
                itemscope
                itemtype="https://schema.org/Article"
              >
                <a
                  href={`/${post.slug}`}
                  class="blog-post-link block no-underline text-black dark:text-white"
                >
                  <div class="md:flex md:gap-6 md:items-start">
                    {/* Mobile: Image on top */}
                    <div class="md:hidden">
                      {post.data.coverImage && (
                        <div class="mb-4 overflow-hidden rounded-md">
                          <Image
                            src={post.data.coverImage}
                            alt={post.data.coverImageAlt || post.data.title}
                            width={800}
                            height={400}
                            class="w-full h-48 object-cover transition-transform duration-200 hover:scale-105"
                            widths={[640, 768, 1024, 1920]}
                            sizes="(max-width: 768px) 100vw, 800px"
                          />
                        </div>
                      )}
                    </div>

                    {/* Content */}
                    <div class="md:flex-1">
                      <header class="mb-4">
                        <h3
                          class="post-title text-2xl font-bold mb-3 transition-opacity duration-200 text-black dark:text-white"
                          itemprop="headline"
                        >
                          {post.data.title}
                        </h3>
                        <div class="flex items-center gap-4 text-sm text-black dark:text-white">
                          <time
                            datetime={post.data.date.toISOString()}
                            itemprop="datePublished"
                          >
                            {format(post.data.date, 'MMMM d, yyyy')}
                          </time>
                          <span class="text-gray-500 dark:text-gray-400">
                            {formatReadTime(calculateReadTime(post.body))}
                          </span>
                        </div>
                      </header>
                      <p
                        class="text-black dark:text-white mb-4 text-base leading-relaxed"
                        itemprop="description"
                      >
                        {post.data.excerpt}
                      </p>
                    </div>

                    {/* Desktop: Image on right */}
                    <div class="hidden md:block md:flex-shrink-0">
                      {post.data.coverImage && (
                        <div class="w-48 h-32 overflow-hidden rounded-md">
                          <Image
                            src={post.data.coverImage}
                            alt={post.data.coverImageAlt || post.data.title}
                            width={800}
                            height={400}
                            class="w-full h-full object-cover transition-transform duration-200 hover:scale-105"
                            widths={[640, 768, 1024, 1920]}
                            sizes="(max-width: 768px) 100vw, 800px"
                          />
                        </div>
                      )}
                    </div>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </section>
      )}
    </main>

    <Footer />
  </div>
</BaseLayout>
